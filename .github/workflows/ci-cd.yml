name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥

env:
  DOCKER_IMAGE_NAME: ksnu-portfolio-api
  DOCKER_REGISTRY: ghcr.io
  REGISTRY_USERNAME: ${{ github.actor }}

jobs:
  # CI ì‘ì—…: ë°±ì—”ë“œ API í…ŒìŠ¤íŠ¸
  test-api:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout ì½”ë“œ
      uses: actions/checkout@v4

    - name: í™˜ê²½ë³€ìˆ˜ ì„¤ì • (CIìš©)
      run: |
        echo "ğŸ”§ CI í™˜ê²½ì„ ìœ„í•œ í™˜ê²½ë³€ìˆ˜ ì„¤ì •..."
        echo "MONGODB_URI=mongodb://test:test@localhost:27017/test?authSource=admin" >> $GITHUB_ENV
        echo "DB_NAME=test" >> $GITHUB_ENV
        echo "NODE_ENV=test" >> $GITHUB_ENV
        echo "API_PORT=3000" >> $GITHUB_ENV
        echo "CORS_ORIGIN=*" >> $GITHUB_ENV

    - name: MongoDB ì‹œì‘ (í…ŒìŠ¤íŠ¸ìš©)
      run: |
        docker run -d \
          --name test-mongodb \
          -p 27017:27017 \
          -e MONGO_INITDB_ROOT_USERNAME=test \
          -e MONGO_INITDB_ROOT_PASSWORD=test \
          mongo:8.0
        sleep 10

    - name: Docker Composeë¡œ API ì„œë¹„ìŠ¤ í…ŒìŠ¤íŠ¸
      run: |
        echo "ğŸ§ª API ì„œë¹„ìŠ¤ë¥¼ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤..."
        docker compose up -d api
        sleep 10
        # API ì„œë¹„ìŠ¤ê°€ ì •ìƒì ìœ¼ë¡œ ì‘ë‹µí•˜ëŠ”ì§€ í™•ì¸
        curl -f http://localhost:3000/health || exit 1
        echo "âœ… API ì„œë¹„ìŠ¤ê°€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ë˜ê³  ìˆìŠµë‹ˆë‹¤!"

    - name: API ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸
      run: |
        echo "ğŸ§ª API ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸..."
        curl -f http://localhost:3000/api/comments || echo "ëŒ“ê¸€ API í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"

    - name: ì„œë¹„ìŠ¤ ë¡œê·¸ í™•ì¸
      if: always()
      run: |
        echo "ğŸ“‹ API ì„œë¹„ìŠ¤ ë¡œê·¸:"
        docker compose logs api || echo "API ì„œë¹„ìŠ¤ ë¡œê·¸ ì—†ìŒ"

    - name: Docker Compose ì •ë¦¬
      if: always()
      run: |
        docker compose down -v
        docker stop test-mongodb || true
        docker rm test-mongodb || true

    - name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½
      run: |
        echo "âœ… CI ë‹¨ê³„ ì™„ë£Œ!"
        echo "- ë°±ì—”ë“œ APIê°€ ì •ìƒì ìœ¼ë¡œ ì‹œì‘ë˜ê³  ì‘ë‹µí•©ë‹ˆë‹¤."

  # ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
  unit-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout ì½”ë“œ
      uses: actions/checkout@v4

    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json

    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      working-directory: backend
      run: npm ci

    - name: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      working-directory: backend
      run: npm test
      env:
        NODE_ENV: test

    - name: í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ì—…ë¡œë“œ
      uses: codecov/codecov-action@v3
      with:
        files: ./backend/coverage/lcov.info
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  # Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
  build-and-push:
    needs: [test-api, unit-test]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout ì½”ë“œ
      uses: actions/checkout@v4

    - name: Docker Buildx ì„¤ì •
      uses: docker/setup-buildx-action@v3

    - name: GitHub Container Registry ë¡œê·¸ì¸
      uses: docker/login-action@v3
      with:
        registry: ${{ env.DOCKER_REGISTRY }}
        username: ${{ env.REGISTRY_USERNAME }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Docker ë©”íƒ€ë°ì´í„° ì¶”ì¶œ
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.DOCKER_REGISTRY }}/${{ github.repository_owner }}/${{ env.DOCKER_IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}

    - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      id: build-and-push
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64,linux/arm64

    - name: ì´ë¯¸ì§€ ë‹¤ì´ì œìŠ¤íŠ¸ ì¶œë ¥
      run: echo "Image digest - ${{ steps.build-and-push.outputs.digest }}"

  # Kubernetes ë°°í¬ (ì„ íƒì‚¬í•­ - ìˆ˜ë™ ì‹¤í–‰)
  deploy-k8s:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout ì½”ë“œ
      uses: actions/checkout@v4

    - name: Kubernetes ì„¤ì •
      uses: azure/k8s-set-context@v3
      with:
        method: kubeconfig
        kubeconfig: ${{ secrets.KUBE_CONFIG }}

    - name: Kubernetes ì‹œí¬ë¦¿ ìƒì„±/ì—…ë°ì´íŠ¸
      run: |
        kubectl create secret generic mongodb-secret \
          --from-literal=mongodb-uri="${{ secrets.MONGODB_URI }}" \
          --from-literal=db-name="${{ secrets.DB_NAME }}" \
          -n portfolio \
          --dry-run=client -o yaml | kubectl apply -f -

    - name: Kubernetes ë¦¬ì†ŒìŠ¤ ë°°í¬
      run: |
        kubectl apply -f k8s/namespace.yaml
        kubectl apply -f k8s/api-configmap.yaml
        kubectl apply -f k8s/mongodb-pvc.yaml
        kubectl apply -f k8s/mongodb-deployment.yaml
        kubectl apply -f k8s/mongodb-service.yaml
        kubectl apply -f k8s/api-deployment.yaml
        kubectl apply -f k8s/api-service.yaml
        kubectl apply -f k8s/api-hpa.yaml

    - name: ë°°í¬ ìƒíƒœ í™•ì¸
      run: |
        kubectl rollout status deployment/portfolio-api -n portfolio --timeout=5m
        kubectl get pods -n portfolio
        kubectl get services -n portfolio

    - name: ë°°í¬ ì™„ë£Œ ì•Œë¦¼
      run: |
        echo "âœ… Kubernetes ë°°í¬ ì™„ë£Œ!"
        echo "ğŸ“¦ ì´ë¯¸ì§€: ${{ env.DOCKER_REGISTRY }}/${{ github.repository_owner }}/${{ env.DOCKER_IMAGE_NAME }}:latest"
