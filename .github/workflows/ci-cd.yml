name: CI/CD Pipeline

on:
  # Nginx μ κ±°λ΅ μΈν•΄ Docker λΉλ“ λΉ„ν™μ„±ν™”
  # push:
  #   branches: [ main, develop ]
  # pull_request:
  #   branches: [ main ]
  workflow_dispatch:  # μλ™ μ‹¤ν–‰λ§ κ°€λ¥

env:
  DOCKER_IMAGE_NAME: portfolio-web
  DOCKER_REGISTRY: ghcr.io

jobs:
  # CI μ‘μ—…: λ°±μ—”λ“ API ν…μ¤νΈ
  test-api:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout μ½”λ“
      uses: actions/checkout@v4

    - name: ν™κ²½λ³€μ μ„¤μ • (CIμ©)
      run: |
        echo "π”§ CI ν™κ²½μ„ μ„ν• ν™κ²½λ³€μ μ„¤μ •..."
        echo "MONGODB_URI=mongodb://test:test@localhost:27017/test?authSource=admin" >> $GITHUB_ENV
        echo "DB_NAME=test" >> $GITHUB_ENV
        echo "NODE_ENV=test" >> $GITHUB_ENV
        echo "API_PORT=3000" >> $GITHUB_ENV
        echo "CORS_ORIGIN=*" >> $GITHUB_ENV

    - name: MongoDB μ‹μ‘ (ν…μ¤νΈμ©)
      run: |
        docker run -d \
          --name test-mongodb \
          -p 27017:27017 \
          -e MONGO_INITDB_ROOT_USERNAME=test \
          -e MONGO_INITDB_ROOT_PASSWORD=test \
          mongo:8.0
        sleep 10

    - name: Docker Composeλ΅ API μ„λΉ„μ¤ ν…μ¤νΈ
      run: |
        echo "π§ API μ„λΉ„μ¤λ¥Ό ν…μ¤νΈν•©λ‹λ‹¤..."
        docker compose up -d api
        sleep 10
        # API μ„λΉ„μ¤κ°€ μ •μƒμ μΌλ΅ μ‘λ‹µν•λ”μ§€ ν™•μΈ
        curl -f http://localhost:3000/health || exit 1
        echo "β… API μ„λΉ„μ¤κ°€ μ •μƒμ μΌλ΅ μ‹¤ν–‰λκ³  μμµλ‹λ‹¤!"

    - name: API μ—”λ“ν¬μΈνΈ ν…μ¤νΈ
      run: |
        echo "π§ API μ—”λ“ν¬μΈνΈ ν…μ¤νΈ..."
        curl -f http://localhost:3000/api/comments || echo "λ“κΈ€ API ν…μ¤νΈ μ‹¤ν¨"

    - name: μ„λΉ„μ¤ λ΅κ·Έ ν™•μΈ
      if: always()
      run: |
        echo "π“‹ API μ„λΉ„μ¤ λ΅κ·Έ:"
        docker compose logs api || echo "API μ„λΉ„μ¤ λ΅κ·Έ μ—†μ"

    - name: Docker Compose μ •λ¦¬
      if: always()
      run: |
        docker compose down -v
        docker stop test-mongodb || true
        docker rm test-mongodb || true

    - name: ν…μ¤νΈ κ²°κ³Ό μ”μ•½
      run: |
        echo "β… CI λ‹¨κ³„ μ™„λ£!"
        echo "- λ°±μ—”λ“ APIκ°€ μ •μƒμ μΌλ΅ μ‹μ‘λκ³  μ‘λ‹µν•©λ‹λ‹¤."
